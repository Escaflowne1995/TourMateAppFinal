<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management Test - Tourist App Admin</title>
    <link rel="stylesheet" href="web-interface/styles/AdminApp.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    
    <!-- Load Configuration and Services -->
    <script src="config/supabaseClient.js"></script>
    <script src="config/adminConfig.js"></script>
    <script src="services/adminServiceSimple.js"></script>
    <script src="services/userManagementSupabase.js"></script>
    
    <!-- Load Components -->
    <script src="web-interface/components/UserEditModal.js"></script>
    <script src="web-interface/components/UserManagement.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        function TestApp() {
            const [debugInfo, setDebugInfo] = useState({});
            const [loading, setLoading] = useState(true);
            
            // Mock admin user for testing
            const mockAdmin = {
                id: 'admin_1',
                name: 'Test Admin',
                email: 'admin@touristapp.com',
                role: 'admin'
            };
            
            useEffect(() => {
                const runTests = async () => {
                    console.log('üîç Starting user management tests...');
                    
                    try {
                        // Initialize admin service
                        if (window.AdminService) {
                            window.AdminService.login(mockAdmin);
                            console.log('‚úÖ Admin service logged in');
                        }
                        
                        // Test Supabase connection
                        if (window.supabase) {
                            console.log('‚úÖ Supabase client available');
                            
                            // Test direct profiles access
                            console.log('üîç Testing profiles table access...');
                            const { data: profiles, error: profilesError, count } = await window.supabase
                                .from('profiles')
                                .select('*', { count: 'exact' })
                                .limit(5);
                            
                            if (profilesError) {
                                console.error('‚ùå Profiles access error:', profilesError);
                                setDebugInfo(prev => ({
                                    ...prev,
                                    profilesError: profilesError.message,
                                    suggestion: profilesError.message.includes('permission denied') || profilesError.message.includes('RLS') 
                                        ? 'Run the fix-user-access.sql script in your Supabase dashboard'
                                        : 'Check your database connection'
                                }));
                            } else {
                                console.log('‚úÖ Profiles access successful:', { count, profiles });
                                setDebugInfo(prev => ({
                                    ...prev,
                                    profilesCount: count,
                                    sampleProfiles: profiles?.slice(0, 3),
                                    profilesSuccess: true
                                }));
                            }
                        }
                        
                        // Test UserManagementService
                        if (window.UserManagementService) {
                            console.log('‚úÖ UserManagementService available');
                            console.log('üîç Testing getAllUsers...');
                            
                            const result = await window.UserManagementService.getAllUsers();
                            console.log('üìä getAllUsers result:', result);
                            
                            setDebugInfo(prev => ({
                                ...prev,
                                serviceTest: result,
                                serviceSuccess: result.success
                            }));
                        } else {
                            console.error('‚ùå UserManagementService not available');
                            setDebugInfo(prev => ({
                                ...prev,
                                serviceError: 'UserManagementService not loaded'
                            }));
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Test error:', error);
                        setDebugInfo(prev => ({
                            ...prev,
                            generalError: error.message
                        }));
                    } finally {
                        setLoading(false);
                    }
                };
                
                setTimeout(runTests, 1000); // Give services time to load
            }, []);
            
            return (
                <div className="admin-container">
                    <div className="admin-main" style={{ marginLeft: 0, padding: '2rem' }}>
                        <div style={{ marginBottom: '2rem' }}>
                            <h1 style={{ fontSize: '2.5rem', fontWeight: '700', marginBottom: '0.5rem', color: 'var(--primary-color)' }}>
                                üèñÔ∏è User Management Test
                            </h1>
                            <p style={{ color: 'var(--text-secondary)', fontSize: '1.1rem' }}>
                                Testing connection to real user data in Supabase
                            </p>
                        </div>
                        
                        {/* Debug Information */}
                        <div style={{ 
                            background: loading ? '#f8f9fa' : (debugInfo.serviceSuccess ? '#d4edda' : '#f8d7da'),
                            border: `1px solid ${loading ? '#dee2e6' : (debugInfo.serviceSuccess ? '#c3e6cb' : '#f5c6cb')}`,
                            color: loading ? '#495057' : (debugInfo.serviceSuccess ? '#155724' : '#721c24'),
                            padding: '1rem',
                            borderRadius: 'var(--radius-md)',
                            marginBottom: '2rem'
                        }}>
                            <h3 style={{ margin: '0 0 1rem 0' }}>
                                <i className={`fas ${loading ? 'fa-spinner fa-spin' : (debugInfo.serviceSuccess ? 'fa-check-circle' : 'fa-exclamation-triangle')}`}></i>
                                {loading ? ' Running Tests...' : (debugInfo.serviceSuccess ? ' Connection Successful!' : ' Connection Issues Detected')}
                            </h3>
                            
                            {!loading && (
                                <div style={{ fontSize: '0.9rem' }}>
                                    <div><strong>Profiles Count:</strong> {debugInfo.profilesCount || 'N/A'}</div>
                                    <div><strong>Service Available:</strong> {window.UserManagementService ? '‚úÖ Yes' : '‚ùå No'}</div>
                                    <div><strong>Supabase Connected:</strong> {window.supabase ? '‚úÖ Yes' : '‚ùå No'}</div>
                                    
                                    {debugInfo.profilesError && (
                                        <div style={{ marginTop: '1rem', padding: '0.5rem', background: 'rgba(255,255,255,0.1)', borderRadius: '4px' }}>
                                            <strong>Database Error:</strong> {debugInfo.profilesError}
                                            {debugInfo.suggestion && (
                                                <div style={{ marginTop: '0.5rem' }}>
                                                    <strong>üí° Solution:</strong> {debugInfo.suggestion}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {debugInfo.sampleProfiles && debugInfo.sampleProfiles.length > 0 && (
                                        <div style={{ marginTop: '1rem' }}>
                                            <strong>Sample Users Found:</strong>
                                            <ul style={{ margin: '0.5rem 0', paddingLeft: '1.5rem' }}>
                                                {debugInfo.sampleProfiles.map((profile, idx) => (
                                                    <li key={idx}>{profile.name || 'Unnamed'} ({profile.email || 'No email'})</li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {/* User Management Interface */}
                        {!loading && debugInfo.serviceSuccess && (
                            <div>
                                <h2 style={{ marginBottom: '1rem' }}>User Management Interface</h2>
                                <window.UserManagement currentAdmin={mockAdmin} />
                            </div>
                        )}
                        
                        {/* Setup Instructions */}
                        {!loading && !debugInfo.serviceSuccess && (
                            <div className="card">
                                <div className="card-header">
                                    <h3 className="card-title">
                                        <i className="fas fa-tools"></i>
                                        Setup Instructions
                                    </h3>
                                </div>
                                <div className="card-body">
                                    <ol style={{ paddingLeft: '1.5rem' }}>
                                        <li style={{ marginBottom: '1rem' }}>
                                            <strong>Open your Supabase Dashboard</strong>
                                            <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                                                Go to <code>https://supabase.com/dashboard</code>
                                            </div>
                                        </li>
                                        <li style={{ marginBottom: '1rem' }}>
                                            <strong>Navigate to SQL Editor</strong>
                                            <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                                                Click on "SQL Editor" in the left sidebar
                                            </div>
                                        </li>
                                        <li style={{ marginBottom: '1rem' }}>
                                            <strong>Run the Setup Script</strong>
                                            <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                                                Copy and run the contents of <code>admin/fix-user-access.sql</code>
                                            </div>
                                        </li>
                                        <li>
                                            <strong>Refresh this page</strong>
                                            <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                                                The user management interface should now show existing users
                                            </div>
                                        </li>
                                    </ol>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>
